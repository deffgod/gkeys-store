# План разработки: Интеграция G2A, Prisma DB, Redis и Админ-панель

## Обзор

Этот план описывает необходимые изменения для обеспечения корректной работы взаимодействий между G2A API, Prisma DB, Redis и админ-панелью, а также проверку и исправление функциональности регистрации, авторизации, корзины, избранного и админ-редактирования.

---

## Фаза 1: Аудит текущего состояния и выявление проблем

### 1.1 Проверка взаимодействия G2A ↔ Prisma DB ↔ Redis

**Задачи:**
- [ ] **T001** Проверить, что G2A OAuth2 токены корректно кешируются в Redis
  - Файл: `backend/src/services/g2a.service.ts`
  - Проверить функцию `getOAuth2Token()`
  - Убедиться, что токены обновляются до истечения (5 минут до expiry)
  - Проверить обработку ошибок Redis

- [ ] **T002** Проверить синхронизацию G2A продуктов в Prisma DB
  - Файл: `backend/src/services/g2a.service.ts`
  - Проверить функцию `syncG2ACatalog()`
  - Убедиться, что поля `g2aProductId`, `g2aStock`, `g2aLastSync` обновляются корректно
  - Проверить обработку ошибок при синхронизации

- [ ] **T003** Проверить инвалидацию кеша Redis после синхронизации G2A
  - Файл: `backend/src/services/g2a.service.ts` (строка ~1540)
  - Убедиться, что после `syncG2ACatalog()` вызывается `invalidateCache()`
  - Проверить паттерны инвалидации: `home:*`, `game:*`, `catalog:*`
  - Убедиться, что инвалидация не блокирует синхронизацию при ошибках

- [ ] **T004** Проверить отслеживание прогресса синхронизации в Redis
  - Файл: `backend/src/services/g2a.service.ts`
  - Проверить функции `updateSyncProgress()`, `getG2ASyncProgress()`
  - Убедиться, что прогресс сохраняется и читается из Redis
  - Проверить fallback на in-memory при недоступности Redis

- [ ] **T005** Проверить блокировку синхронизации (prevent concurrent syncs)
  - Файл: `backend/src/services/g2a.service.ts`
  - Проверить функции `acquireSyncLock()`, `releaseSyncLock()`
  - Убедиться, что блокировка работает корректно
  - Проверить TTL блокировки (1 час)

### 1.2 Проверка регистрации и авторизации

**Задачи:**
- [ ] **T006** Проверить регистрацию пользователей
  - Файл: `backend/src/services/auth.service.ts` (функция `register`)
  - Проверить хеширование паролей (bcrypt)
  - Проверить отправку email при регистрации
  - Проверить создание JWT токенов
  - Проверить обработку дубликатов email

- [ ] **T007** Проверить авторизацию пользователей
  - Файл: `backend/src/services/auth.service.ts` (функция `login`)
  - Проверить валидацию email и пароля
  - Проверить генерацию access и refresh токенов
  - Проверить обработку неверных credentials

- [ ] **T008** Проверить middleware аутентификации
  - Файл: `backend/src/middleware/auth.ts`
  - Проверить функцию `authenticate()`
  - Убедиться, что токены валидируются корректно
  - Проверить обработку истекших токенов

- [ ] **T009** Проверить refresh token механизм
  - Файл: `backend/src/services/auth.service.ts` (функция `refreshToken`)
  - Проверить валидацию refresh token
  - Проверить генерацию новых токенов
  - Проверить обработку невалидных refresh токенов

- [ ] **T010** Проверить миграцию корзины и избранного при логине
  - Файл: `backend/src/controllers/cart.controller.ts` (функция `migrateCartController`)
  - Файл: `backend/src/controllers/wishlist.controller.ts` (функция `migrateWishlistController`)
  - Убедиться, что миграция вызывается после успешного логина
  - Проверить, что sessionId корректно передается в middleware
  - Проверить обработку ошибок миграции

### 1.3 Проверка корзины и избранного

**Задачи:**
- [ ] **T011** Проверить добавление товаров в корзину
  - Файл: `backend/src/services/cart.service.ts` (функция `addToCart`)
  - Проверить поддержку guest sessions (sessionId)
  - Проверить поддержку authenticated users (userId)
  - Проверить валидацию наличия товара (inStock)
  - Проверить обновление количества при повторном добавлении

- [ ] **T012** Проверить обновление и удаление из корзины
  - Файл: `backend/src/services/cart.service.ts`
  - Проверить функции `updateCartItem()`, `removeFromCart()`, `clearCart()`
  - Проверить обработку quantity = 0 (должно удалять)
  - Проверить валидацию userId/sessionId

- [ ] **T013** Проверить добавление в избранное
  - Файл: `backend/src/services/wishlist.service.ts` (функция `addToWishlist`)
  - Проверить поддержку guest sessions и authenticated users
  - Проверить предотвращение дубликатов
  - Проверить валидацию существования игры

- [ ] **T014** Проверить удаление из избранного
  - Файл: `backend/src/services/wishlist.service.ts` (функция `removeFromWishlist`)
  - Проверить обработку несуществующих записей
  - Проверить валидацию userId/sessionId

- [ ] **T015** Проверить фронтенд контексты корзины и избранного
  - Файл: `src/context/CartContext.tsx`
  - Файл: `src/context/WishlistContext.tsx`
  - Убедиться, что миграция вызывается при логине (useEffect с user?.id)
  - Проверить обработку ошибок
  - Проверить обновление UI после операций

### 1.4 Проверка админ-панели

**Задачи:**
- [ ] **T016** Проверить авторизацию админа
  - Файл: `backend/src/middleware/auth.ts` (функция `requireAdmin`)
  - Убедиться, что проверяется `req.user.role === 'ADMIN'`
  - Проверить возврат 403 для non-admin пользователей
  - Проверить, что все admin routes используют `requireAdmin` middleware

- [ ] **T017** Проверить CRUD операции для игр в админ-панели
  - Файл: `backend/src/services/admin.service.ts`
  - Проверить функции `getAllGames()`, `createGame()`, `updateGame()`, `deleteGame()`
  - Убедиться, что можно редактировать все поля, включая G2A-связанные (`g2aProductId`, `g2aStock`, `g2aLastSync`)
  - Проверить создание/обновление связей (platforms, genres, tags, categories)
  - Проверить инвалидацию кеша после изменений

- [ ] **T018** Проверить CRUD операции для пользователей
  - Файл: `backend/src/services/admin.service.ts`
  - Проверить функции `searchUsers()`, `getUserDetails()`
  - Убедиться, что админ может видеть всех пользователей
  - Проверить фильтрацию и пагинацию

- [ ] **T019** Проверить CRUD операции для заказов
  - Файл: `backend/src/services/admin.service.ts`
  - Проверить функции `getAllOrders()`, `updateOrderStatus()`
  - Убедиться, что админ может видеть все заказы
  - Проверить обновление статусов заказов

- [ ] **T020** Проверить CRUD операции для блог-постов
  - Файл: `backend/src/services/admin.service.ts`
  - Проверить функции `getAllBlogPosts()`, `createBlogPost()`, `updateBlogPost()`, `deleteBlogPost()`
  - Убедиться, что все операции работают корректно

- [ ] **T021** Проверить G2A синхронизацию в админ-панели
  - Файл: `backend/src/controllers/admin.controller.ts`
  - Проверить функции `syncG2AController()`, `getG2ASyncProgressController()`, `getG2AStatusController()`
  - Убедиться, что админ может запускать синхронизацию
  - Проверить отображение прогресса синхронизации
  - Проверить отображение статуса G2A подключения

- [ ] **T022** Проверить фронтенд админ-панели
  - Файл: `src/admin/AdminApp.tsx`
  - Файл: `src/admin/services/adminApi.ts`
  - Убедиться, что все API вызовы корректны
  - Проверить обработку ошибок
  - Проверить отображение данных

---

## Фаза 2: Исправление выявленных проблем

### 2.1 Улучшение взаимодействия G2A ↔ Prisma DB ↔ Redis

**Задачи:**
- [ ] **T023** Улучшить обработку ошибок Redis в G2A сервисе
  - Файл: `backend/src/services/g2a.service.ts`
  - Добавить более детальное логирование ошибок Redis
  - Улучшить fallback механизмы при недоступности Redis
  - Добавить retry логику для критических операций

- [ ] **T024** Добавить инвалидацию кеша при обновлении игр через админ-панель
  - Файл: `backend/src/services/admin.service.ts`
  - В функциях `updateGame()`, `createGame()`, `deleteGame()` добавить вызов `invalidateCache()`
  - Инвалидировать паттерны: `home:*`, `game:*`, `catalog:*`

- [ ] **T025** Улучшить синхронизацию G2A продуктов
  - Файл: `backend/src/services/g2a.service.ts`
  - Добавить более детальное логирование этапов синхронизации
  - Улучшить обработку частичных ошибок (некоторые продукты не синхронизировались)
  - Добавить метрики синхронизации (время, количество ошибок)

- [ ] **T026** Добавить автоматическую инвалидацию кеша при изменении stock через G2A
  - Файл: `backend/src/jobs/g2a-sync.job.ts`
  - После обновления stock в Prisma DB вызывать `invalidateCache('game:*')`
  - Это обеспечит актуальность данных в кеше

### 2.2 Исправление регистрации и авторизации

**Задачи:**
- [ ] **T027** Убедиться, что миграция корзины/избранного вызывается после логина
  - Файл: `backend/src/controllers/auth.controller.ts`
  - В функции `loginController` после успешного логина вызвать миграцию
  - Или убедиться, что фронтенд вызывает миграцию (проверить `LoginSideMenu.tsx`)

- [ ] **T028** Добавить валидацию sessionId в middleware
  - Файл: `backend/src/middleware/session.middleware.ts`
  - Убедиться, что sessionId генерируется для guest пользователей
  - Проверить, что sessionId передается в запросах корзины/избранного

- [ ] **T029** Улучшить обработку ошибок в auth сервисе
  - Файл: `backend/src/services/auth.service.ts`
  - Добавить более информативные сообщения об ошибках
  - Улучшить логирование

### 2.3 Улучшение корзины и избранного

**Задачи:**
- [ ] **T030** Добавить проверку наличия товара перед добавлением в корзину
  - Файл: `backend/src/services/cart.service.ts`
  - В функции `addToCart` проверить `game.inStock` и `game.g2aStock`
  - Если товар отсутствует, вернуть понятную ошибку

- [ ] **T031** Улучшить миграцию корзины/избранного
  - Файл: `backend/src/services/cart.service.ts` (функция `migrateSessionCartToUser`)
  - Файл: `backend/src/services/wishlist.service.ts` (функция `migrateSessionWishlistToUser`)
  - Добавить транзакции для атомарности операций
  - Улучшить обработку ошибок
  - Добавить логирование

- [ ] **T032** Добавить валидацию данных в cart/wishlist сервисах
  - Файл: `backend/src/services/cart.service.ts`
  - Файл: `backend/src/services/wishlist.service.ts`
  - Проверить, что gameId существует в базе
  - Проверить, что quantity > 0 для корзины

### 2.4 Улучшение админ-панели

**Задачи:**
- [ ] **T033** Добавить возможность редактирования G2A-полей в админ-панели
  - Файл: `backend/src/services/admin.service.ts` (функция `updateGame`)
  - Добавить поддержку обновления `g2aProductId`, `g2aStock`, `g2aLastSync`
  - Файл: `backend/src/types/admin.ts` - добавить эти поля в `GameUpdateInput`

- [ ] **T034** Добавить отображение G2A-полей в админ-панели
  - Файл: `src/admin/pages/GamesPage.tsx`
  - Добавить отображение `g2aProductId`, `g2aStock`, `g2aLastSync` в списке игр
  - Добавить возможность редактирования этих полей в форме редактирования

- [ ] **T035** Улучшить отображение прогресса G2A синхронизации
  - Файл: `src/admin/pages/G2ASyncPage.tsx`
  - Добавить real-time обновление прогресса (polling или WebSocket)
  - Добавить визуализацию прогресса (progress bar)
  - Добавить отображение ошибок синхронизации

- [ ] **T036** Добавить инвалидацию кеша при изменениях через админ-панель
  - Файл: `backend/src/services/admin.service.ts`
  - В функциях `updateGame()`, `createGame()`, `deleteGame()` добавить:
    ```typescript
    import { invalidateCache } from './cache.service.js';
    await invalidateCache('home:*');
    await invalidateCache('game:*');
    await invalidateCache('catalog:*');
    ```

- [ ] **T037** Улучшить обработку ошибок в админ-панели
  - Файл: `backend/src/controllers/admin.controller.ts`
  - Добавить более информативные сообщения об ошибках
  - Улучшить валидацию входных данных

---

## Фаза 3: Тестирование и валидация

### 3.1 Тестирование G2A интеграции

**Задачи:**
- [ ] **T038** Протестировать синхронизацию G2A продуктов
  - Запустить полную синхронизацию через админ-панель
  - Проверить, что продукты корректно создаются/обновляются в Prisma DB
  - Проверить, что кеш Redis инвалидируется
  - Проверить, что прогресс синхронизации отображается корректно

- [ ] **T039** Протестировать OAuth2 токены
  - Проверить, что токены кешируются в Redis
  - Проверить, что токены обновляются до истечения
  - Проверить fallback при недоступности Redis

- [ ] **T040** Протестировать stock проверку
  - Запустить job для проверки stock
  - Проверить, что stock обновляется в Prisma DB
  - Проверить, что кеш инвалидируется

### 3.2 Тестирование регистрации и авторизации

**Задачи:**
- [ ] **T041** Протестировать регистрацию
  - Создать нового пользователя
  - Проверить, что пароль хешируется
  - Проверить, что email отправляется
  - Проверить, что JWT токены генерируются

- [ ] **T042** Протестировать авторизацию
  - Войти с правильными credentials
  - Проверить, что токены возвращаются
  - Проверить, что миграция корзины/избранного происходит
  - Войти с неправильными credentials (должна быть ошибка)

- [ ] **T043** Протестировать refresh token
  - Использовать refresh token для получения новых токенов
  - Проверить, что старые токены инвалидируются
  - Проверить обработку истекших refresh токенов

### 3.3 Тестирование корзины и избранного

**Задачи:**
- [ ] **T044** Протестировать корзину для guest пользователя
  - Добавить товары в корзину без авторизации
  - Проверить, что товары сохраняются
  - Проверить обновление количества
  - Проверить удаление товаров

- [ ] **T045** Протестировать корзину для authenticated пользователя
  - Войти в систему
  - Добавить товары в корзину
  - Проверить, что товары сохраняются
  - Проверить обновление количества
  - Проверить удаление товаров

- [ ] **T046** Протестировать миграцию корзины
  - Добавить товары в корзину как guest
  - Войти в систему
  - Проверить, что товары мигрировали в user cart
  - Проверить, что session cart очистилась

- [ ] **T047** Протестировать избранное
  - Добавить товары в избранное как guest
  - Войти в систему
  - Проверить, что товары мигрировали
  - Проверить удаление из избранного

### 3.4 Тестирование админ-панели

**Задачи:**
- [ ] **T048** Протестировать авторизацию админа
  - Попытаться зайти в админ-панель как обычный пользователь (должна быть ошибка 403)
  - Зайти как админ (должен быть доступ)

- [ ] **T049** Протестировать CRUD операции для игр
  - Создать новую игру
  - Редактировать игру (включая G2A-поля)
  - Удалить игру
  - Проверить, что кеш инвалидируется после изменений

- [ ] **T050** Протестировать CRUD операции для пользователей
  - Просмотреть список пользователей
  - Просмотреть детали пользователя
  - Проверить фильтрацию и пагинацию

- [ ] **T051** Протестировать CRUD операции для заказов
  - Просмотреть список заказов
  - Обновить статус заказа
  - Проверить фильтрацию

- [ ] **T052** Протестировать G2A синхронизацию в админ-панели
  - Запустить синхронизацию через админ-панель
  - Проверить отображение прогресса
  - Проверить статус подключения

---

## Фаза 4: Документация и финализация

### 4.1 Документация

**Задачи:**
- [ ] **T053** Обновить документацию по G2A интеграции
  - Описать процесс синхронизации
  - Описать использование Redis для кеширования
  - Описать обработку ошибок

- [ ] **T054** Обновить документацию по админ-панели
  - Описать все доступные функции
  - Описать процесс редактирования игр
  - Описать G2A синхронизацию

- [ ] **T055** Создать руководство по тестированию
  - Описать процесс тестирования всех функций
  - Описать ожидаемые результаты

### 4.2 Финальная проверка

**Задачи:**
- [ ] **T056** Провести полное тестирование всех функций
  - Регистрация и авторизация
  - Корзина и избранное
  - Админ-панель
  - G2A синхронизация

- [ ] **T057** Проверить производительность
  - Проверить время ответа API
  - Проверить использование Redis кеша
  - Проверить нагрузку на базу данных

- [ ] **T058** Проверить безопасность
  - Проверить валидацию входных данных
  - Проверить авторизацию
  - Проверить защиту от SQL injection

---

## Приоритеты

### Критический приоритет (P0)
- T001-T005: Проверка взаимодействия G2A ↔ Prisma DB ↔ Redis
- T006-T010: Проверка регистрации и авторизации
- T011-T015: Проверка корзины и избранного
- T016: Проверка авторизации админа

### Высокий приоритет (P1)
- T017-T022: Проверка админ-панели
- T023-T026: Улучшение взаимодействия G2A ↔ Prisma DB ↔ Redis
- T027-T029: Исправление регистрации и авторизации
- T030-T032: Улучшение корзины и избранного

### Средний приоритет (P2)
- T033-T037: Улучшение админ-панели
- T038-T052: Тестирование всех функций
- T053-T055: Документация

### Низкий приоритет (P3)
- T056-T058: Финальная проверка и оптимизация

---

## Ожидаемые результаты

После выполнения этого плана:

1. **G2A интеграция** будет полностью функциональна:
   - OAuth2 токены кешируются в Redis
   - Продукты синхронизируются в Prisma DB
   - Кеш инвалидируется после синхронизации
   - Прогресс синхронизации отслеживается

2. **Регистрация и авторизация** будут работать корректно:
   - Пользователи могут регистрироваться
   - Пользователи могут авторизовываться
   - Корзина и избранное мигрируют при логине

3. **Корзина и избранное** будут работать для guest и authenticated пользователей:
   - Товары добавляются/удаляются корректно
   - Миграция происходит автоматически при логине

4. **Админ-панель** будет полностью функциональна:
   - Админ может редактировать все данные, включая G2A-поля
   - Кеш инвалидируется при изменениях
   - G2A синхронизация доступна через админ-панель

---

## Примечания

- Все изменения должны быть протестированы перед деплоем
- При работе с Redis необходимо учитывать возможность его недоступности
- Все операции с базой данных должны быть атомарными (использовать транзакции)
- Кеш должен инвалидироваться при любых изменениях данных
- Ошибки должны логироваться и обрабатываться корректно

