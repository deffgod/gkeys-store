# Исправления Environment Variables

## Проблема

Ошибка "Failed to construct 'URL': Invalid base URL" возникала при попытке логина/регистрации, когда `VITE_API_BASE_URL` не был установлен в Vercel Environment Variables.

## Выполненные исправления

### 1. Валидация VITE_API_BASE_URL в коде

**Файл**: `src/services/api.ts`

**Изменения**:
- Добавлена проверка `VITE_API_BASE_URL` в конструкторе `ApiClient`
- Добавлен fallback для development (`http://localhost:3001/api`)
- В production выбрасывается понятная ошибка с инструкциями
- В development выводится предупреждение и используется fallback

**Результат**: Приложение теперь показывает понятную ошибку вместо падения с "Invalid base URL".

### 2. Скрипт проверки переменных окружения

**Файл**: `scripts/check-env.ts` (новый)

**Функционал**:
- Проверка всех обязательных переменных (frontend, backend, G2A)
- Валидация формата URLs и connection strings
- Проверка длины секретов (JWT_SECRET, JWT_REFRESH_SECRET)
- Вывод детального отчета с категориями
- Exit code 1 если отсутствуют обязательные переменные

**Использование**:
```bash
npm run check:env
```

### 3. Документация по минимальному набору

**Файл**: `ENV_SETUP_QUICKSTART.md` (новый)

**Содержание**:
- Минимальный набор переменных для базовой функциональности
- Минимальный набор для админ панели
- Полный набор для production
- Примеры значений для разных окружений
- Troubleshooting распространенных проблем

### 4. Инструкция по настройке в Vercel

**Файл**: `VERCEL_ENV_SETUP.md` (новый)

**Содержание**:
- Пошаговая инструкция добавления переменных через Vercel Dashboard
- Использование Vercel CLI для добавления переменных
- Проверка установленных переменных
- Обновление переменных после деплоя
- Troubleshooting

### 5. Обновление ENVIRONMENT_VARIABLES.md

**Файл**: `ENVIRONMENT_VARIABLES.md`

**Изменения**:
- Добавлена секция "Приоритеты переменных" с категориями:
  - Критично для работы приложения
  - Для админ панели
  - Для G2A интеграции (опционально)
  - Опциональные переменные
- Обновлена сводная таблица с приоритетами
- Добавлены ссылки на новые документы

## Минимальный набор переменных для работы

### Frontend (обязательно)

1. **VITE_API_BASE_URL**
   - Формат: `https://your-project.vercel.app/api`
   - Важно: Должен заканчиваться на `/api`

### Backend (обязательно)

1. **DATABASE_URL** - PostgreSQL connection string
2. **DIRECT_URL** - Прямое подключение к БД (обычно = DATABASE_URL)
3. **JWT_SECRET** - Минимум 32 символа
4. **JWT_REFRESH_SECRET** - Минимум 32 символа
5. **FRONTEND_URL** - URL фронтенда для CORS (без `/api`)
6. **NODE_ENV** - `production`

### Для админ панели

Админ панель использует те же переменные. Дополнительных переменных не требуется. Доступ контролируется через роль пользователя в БД (`role = 'ADMIN'`).

## Следующие шаги

1. **Установить переменные в Vercel**:
   - Откройте Vercel Dashboard → Settings → Environment Variables
   - Добавьте все обязательные переменные
   - См. [VERCEL_ENV_SETUP.md](VERCEL_ENV_SETUP.md) для подробных инструкций

2. **Проверить переменные**:
   ```bash
   npm run check:env
   ```

3. **Передеплоить проект**:
   - Переменные применяются только при новом деплое
   - Сделайте Redeploy в Vercel Dashboard или `vercel --prod`

4. **Протестировать**:
   - Регистрация пользователя
   - Логин
   - Доступ к админ панели (после установки роли ADMIN)

## Документация

- [ENV_SETUP_QUICKSTART.md](ENV_SETUP_QUICKSTART.md) - Минимальный набор переменных
- [VERCEL_ENV_SETUP.md](VERCEL_ENV_SETUP.md) - Инструкция настройки в Vercel
- [ENVIRONMENT_VARIABLES.md](ENVIRONMENT_VARIABLES.md) - Полный справочник

---

**Дата**: 2024-12-23
